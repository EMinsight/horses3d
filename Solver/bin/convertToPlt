#!/bin/bash
# 
#	This script converts all *.hsol files found in RESULTS_FOLDER with
# the appropriate *.mesh file in the MESH_FOLDER, checking before if an
# existing *.tec is newer or older than the *.hsol file.
#########################################################################
#
#
# Configuration:----------------------------------------
SOLUTION_FILTER=${1:-Solution}	#INSERT SOLUTION NAME HERE!
HORSES2PLT_FLAGS=${2:-}					#INSERT FLAGS FOR HORSES2PLT HERE!
RESULTS_FOLDER=${3:-./RESULTS}  #INSERT RESULTS FOLDER HERE!
MESH_FOLDER=${4:-./MESH}				#INSERT MESH FOLDER HERE!
MESH_NAME=${5:-}								#INSERT MESH FILE HERE!
########################################################

########################################################
# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
GRAY='\033[0m'
NC='\033[0m' # No Color
meshfile=$MESH_NAME
########################################################

########################################################
# Auxiliar functions
function extractMeshNumber {
	auxvar=${1##*_}
	echo ${auxvar%%.hmesh*}
}
function extractHsolNumber {
	auxvar=${1##*_}
	echo ${auxvar%%.hsol*}
}
########################################################

i=0
entries="$RESULTS_FOLDER"/"$SOLUTION_FILTER"*.hsol

########################################################
# Find all the mesh files
meshfiles=("$MESH_FOLDER"/"$SOLUTION_FILTER"_*.hmesh)
Nmeshes=${#meshfiles[@]}
if [ $Nmeshes -gt 0 ]; then
	meshfile=${meshfiles[0]}
	imesh=1
fi
########################################################

no_of_entries=0
for entry in $entries
do
	no_of_entries=$((no_of_entries+1))
done

for entry in $entries
do
	i=$((i+1))
	
	
	if [ $imesh -lt $((Nmeshes)) ]; then
		meshnum=$( extractMeshNumber ${meshfiles[$imesh]} )
		hsolnum=$( extractHsolNumber $entry )
		if [ $meshnum -le $hsolnum ]; then 
			meshfile=${meshfiles[$imesh]}
			imesh=$((imesh+1))
		fi
	fi
	
	tecname=$(echo "${entry%.*}").tec
	if [ -f $tecname ]; then
		if [ $entry -nt $tecname ]; then
			printf "${GREEN}(%d/%d) %s...${NC}" "$i" "$no_of_entries" "Converting $entry"
			printf "${RED}"
  			horses2plt $meshfile $entry $HORSES2PLT_FLAGS > /dev/null 
			printf "${NC}"
			if [ $? -eq 0 ]
			then
				printf "${GREEN}done!${NC}\n"
			fi
		else
			printf "${GRAY}(%d/%d) %s${NC}\n" "$i" "$no_of_entries" "$entry conversion skipped since a more recent *.tec file exists"
			
		fi
	else
		printf "${GREEN}(%d/%d) %s...${NC}" "$i" "$no_of_entries" "Converting $entry"
		printf "${RED}"
  		horses2plt $meshfile $entry $HORSES2PLT_FLAGS > /dev/null
		printf "${NC}"
		if [ $? -eq 0 ]
		then
			printf "${GREEN}done!${NC}\n"
		fi
	fi
done
########################################################

